name: Deploy to Staging (base64 + pip install)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    name: Deploy to staging.evlink.se
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH with base64-decoded key
        run: |
          mkdir -p ~/.ssh
          echo "$STAGING_SSH_KEY_B64" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
          ssh-keyscan 144.91.124.233 >> ~/.ssh/known_hosts
        env:
          STAGING_SSH_KEY_B64: ${{ secrets.STAGING_SSH_KEY_B64 }}

      - name: Prepare clean deploy folder
        run: |
          mkdir deploy_tmp
          shopt -s extglob
          cp -r !(deploy_tmp|.git|venv) deploy_tmp/

      - name: Create archive
        run: |
          tar -czf app.tar.gz -C deploy_tmp .

      - name: Upload to server
        run: |
          scp app.tar.gz fastapiuser@144.91.124.233:/tmp/app.tar.gz

      - name: Deploy and restart service
        run: |
          ssh fastapiuser@144.91.124.233 << 'EOF'
            set -e
            cd /opt/apps/evlink-staging/
            rm -rf *
            tar xzf /tmp/app.tar.gz -C /opt/apps/evlink-staging/
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            sudo /bin/systemctl restart evlink-staging
          EOF
