name: Deploy to Staging (with SCP)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    name: Deploy to staging.evlink.se
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        run: |
          sudo apt-get update && sudo apt-get install -y openssh-client
          eval "$(ssh-agent -s)"
          echo "$STAGING_SSH_KEY" | tr -d '\r' | ssh-add -
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan 144.91.124.233 >> ~/.ssh/known_hosts
        env:
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}

      - name: Create temp package
        run: |
          tar czf app.tar.gz --exclude .git --exclude venv .

      - name: Copy to server with scp
        run: |
          scp app.tar.gz fastapiuser@144.91.124.233:/tmp/app.tar.gz

      - name: Extract and restart on server
        run: |
          ssh fastapiuser@144.91.124.233 << 'EOF'
            rm -rf /opt/apps/evlink-staging/*
            tar xzf /tmp/app.tar.gz -C /opt/apps/evlink-staging/
            sudo systemctl restart evlink-staging
          EOF
