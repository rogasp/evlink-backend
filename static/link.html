<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>L√§nka fordon</title>
</head>
<body>
  <h2>üîó L√§nka ditt fordon via Enode</h2>
  <button id="linkBtn">L√§nka fordon</button>

  <script>
    document.getElementById("linkBtn").addEventListener("click", async () => {
      const userId = "rogasp";
      const vendor = "XPENG";

      try {
        const response = await fetch(`/api/user/${userId}/link?vendor=${vendor}`);
        const data = await response.json();

        if (data.linkToken && data.linkUrl) {
          // 1Ô∏è‚É£ Spara token i sessionStorage (delas med popup)
          sessionStorage.setItem("linkToken", data.linkToken);

          // 2Ô∏è‚É£ √ñppna Enode i popup
          window.open(data.linkUrl, "_blank", "width=600,height=800");
        } else {
          alert("‚ùå Kunde inte h√§mta l√§nkdata");
        }
      } catch (err) {
        alert("‚ùå Fel vid anrop: " + err);
      }
    });

    // 3Ô∏è‚É£ Ta emot token tillbaka fr√•n callback.html
    window.addEventListener("message", async (event) => {
      const token = event.data;
      if (!token || typeof token !== "string") return;

      console.log("‚úÖ Mottog token fr√•n popup:", token);

      try {
        const res = await fetch("/api/confirm-link", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token })
        });

        const result = await res.json();
        if (res.ok) {
          alert("‚úÖ L√§nkning klar f√∂r " + result.vendor);
        } else {
          alert("‚ùå Fel: " + result.detail);
        }
      } catch (err) {
        alert("‚ö†Ô∏è Tekniskt fel: " + err);
      }
    });
  </script>
</body>
</html>
