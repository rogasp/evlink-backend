<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EV Link Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 2rem;
    }
    h2, h3 {
      margin-top: 2rem;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      margin-bottom: 1rem;
    }
    input, button {
      padding: 0.4rem;
      font-size: 1rem;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <h1>üîå EV Link Dashboard</h1>

  <div id="authSection">
    <h2>üîê Login</h2>
    <input id="loginUserId" placeholder="User ID">
    <button onclick="login()">Login</button>

    <h2>üÜï Register</h2>
    <input id="registerUserId" placeholder="Choose a User ID">
    <button onclick="register()">Register</button>
  </div>

  <div id="dashboard" class="hidden">
    <h2>üëã Welcome <span id="welcomeUser"></span></h2>
    <button onclick="logout()">üö™ Logout</button>

    <h3>üîë API Key</h3>
    <div id="apiKeyBox"></div>
    <button onclick="createApiKey()">Generate New API Key</button>

    <h3>üè¢ Linked Vendors</h3>
    <ul id="vendorList"></ul>

    <h3>üöó Linked Vehicles</h3>
    <ul id="vehicleList"></ul>
  </div>

  <script>
    const userId = localStorage.getItem("userId");
    const apiKey = localStorage.getItem("apiKey");

    if (userId && apiKey) {
      loadDashboard();
    }

    async function login() {
      const userId = document.getElementById("loginUserId").value.trim();
      if (!userId) return alert("Enter user ID");

      const res = await fetch(`/api/public/user/${userId}`);
      const exists = await res.json();
      if (!exists.exists) return alert("User not found");

      const keyRes = await fetch(`/api/public/user/${userId}/apikey`);
      const keyData = await keyRes.json();

      localStorage.setItem("userId", userId);
      localStorage.setItem("apiKey", keyData.api_key);
      loadDashboard();
    }

    async function register() {
      const userId = document.getElementById("registerUserId").value.trim();
      if (!userId) return alert("Choose a user ID");

      const res = await fetch(`/api/public/user/${userId}`);
      const exists = await res.json();
      if (exists.exists) return alert("User already exists");

      const created = await fetch(`/api/user/${userId}/apikey`, { method: "POST" });
      const keyData = await created.json();

      localStorage.setItem("userId", userId);
      localStorage.setItem("apiKey", keyData.api_key);
      loadDashboard();
    }

    function logout() {
      localStorage.clear();
      document.getElementById("authSection").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
    }

    async function createApiKey() {
      const userId = localStorage.getItem("userId");
      const res = await fetch(`/api/user/${userId}/apikey`, { method: "POST" });
      const data = await res.json();
      localStorage.setItem("apiKey", data.api_key);
      loadDashboard();
    }

    async function loadDashboard() {
      const userId = localStorage.getItem("userId");
      const apiKey = localStorage.getItem("apiKey");

      document.getElementById("welcomeUser").textContent = userId;
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");

      document.getElementById("apiKeyBox").textContent = apiKey;

      // Load vendors
      const vendorList = document.getElementById("vendorList");
      vendorList.innerHTML = "";
      const vendorsRes = await fetch(`/api/user/${userId}`, {
        headers: { "X-API-Key": apiKey }
      });
      const user = await vendorsRes.json();
      if (user.linked_vendors.length === 0) {
        vendorList.innerHTML = "<li>No vendors linked</li>";
      } else {
        user.linked_vendors.forEach(vendor => {
          const li = document.createElement("li");
          li.textContent = vendor;
          vendorList.appendChild(li);
        });
      }

      // Load vehicles
      const vehicleList = document.getElementById("vehicleList");
      vehicleList.innerHTML = "";
      const res = await fetch(`/api/user/${userId}/vehicles`, {
        headers: { "X-API-Key": apiKey }
      });

      if (res.ok) {
        const vehicles = await res.json();
        if (vehicles.length === 0) {
          vehicleList.innerHTML = "<li>No vehicles linked yet.</li>";
        } else {
          vehicles.forEach(vehicle => {
            const info = vehicle.information || {};
            const status = vehicle.isReachable ? "üü¢ Online" : "üî¥ Offline";
            const name = info.displayName || `${info.brand || ""} ${info.model || ""}` || "Unnamed";

            const li = document.createElement("li");
            li.innerHTML = `
              <strong>${name}</strong> (${vehicle.vendor})<br>
              ${info.brand || ""} ${info.model || ""} ${info.year || ""}<br>
              Status: ${status}
              <hr>
            `;
            vehicleList.appendChild(li);
          });
        }
      } else {
        vehicleList.innerHTML = "<li>Failed to load vehicles.</li>";
      }
    }
  </script>
</body>
</html>
